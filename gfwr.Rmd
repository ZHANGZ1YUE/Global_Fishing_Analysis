---
title: "Use Global Fishing Watch API to collect and use fishing data"
author: "Christophe Bontemps, Ziyue Zhang, GFW Documentation"
date: "2023-05-15"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 

```

## Initialization

In order to use the API provided by GFS, we should identify ourself by
using the "key" when requesting any information. We should save this key
as a variable for easy access later.

```{r cars}
library(gfwr)
key <- gfw_auth()    #Access the token and save as "key"
```

## To search about vessels information using identifiers and dataset categories

Every vessel has a unique identifier. It can be MMSI, shipname, id, etc.
We can use any of these identifier to find out a specific vessel and
retrieve information about this vessel. We use the function
`get_vessel_info` to make a request using API. Within this function,
there are several arguments for us to specify, which is very similar
with "searching option" when we use google. 1: `query` is where we input
the identifier. 2: There are three `search_type`: basic, advanced, and
id. "basic" search takes features like MMSI, IMO, callsign, shipname as
inputs and identifies all vessels in the specified dataset that match.
"advanced" search allows for the use of fuzzy matching with terms such
as LIKE. "id" search allows the user to search using a GFW vessel id
allows the user to specify the vessel id (generated by GFW). 3: The user
can also specify which identity `dataset` to use: carrier_vessel,
support_vessel, fishing_vessel, or all. With the latter, all databases
are used for the search. This is generally recommended and is the option
set by default. 4: `key`: indicating who we are when making the request.
(the first "key" is for argument name, and th e second key is the
variable name "key" which we used to store our key previously.)

Example: To get information of a vessel with MMSI = 224224000 using all
datasets:

```{r pressure, echo=FALSE}
get_vessel_info(query = 224224000, 
                search_type = "basic", 
                dataset = "all", 
                key = key)
```

To combine different fields and do fuzzy matching to search the carrier
vessel dataset:

```{r}
get_vessel_info(query = "shipname LIKE '%GABU REEFE%' OR imo = '8300949'", 
                search_type = "advanced", dataset = "carrier_vessel", key = key)
```

To specify a vessel id or multiple ids: (Note that the ids have to be
listed in this way with comma and in same line)

```{r}
get_vessel_info(query = "8c7304226-6c71-edbe-0b63-c246734b3c01,6583c51e3-3626-5638-866a-f47c3bc7ef7c,71e7da672-2451-17da-b239-857831602eca", 
                search_type = 'id', key = key)
```

## To know about "events" (fishing, transshipment, port visit) happening on a specific vessel

We can retrieve information on not only the vessels, but also events
with the API. Event types supported by the API include: apparent fishing
events, potential transshipment events (two-vessel encounters and
loitering by refrigerated carrier vessels), and port visits. You can
visit
(<https://globalfishingwatch.org/our-apis/documentation#data-caveat>)
for how these events are estimated in detail. The function we use to
make a request for events is "get_event". The arguments are event_type,
vessel, confidences, and key. 1: `event_type` is where we specify the
types of events we would like to search 2: `vessel` specify which vessel
we would like to focus on, and we can use the vessel id for this
argument 3: `confidences`: This param applies only to port visits
events. A port visit with low confidence (level = 2) indicates that only
a port stop or gap event was detected using AIS within the port.Only a
port stop OR gap was identified based on AIS transmission. Medium
confidence (level = 3) indicates that a port entry or exit was detected
using AIS, along with a stop or gap within the port. High confidence
(level = 4) indicates that the vessel was identified using AIS with an
entry, stop or gap, and exit within port. A port visit with a lower
confidence may sometimes be a false port visit caused by noisy AIS
transmission and requires a further inspection of the vessel tracks.

Example:

Suppose we only have MMSI of a vessel, and we would like to search about
the events from this vessel. Here are the steps. Firstly, we can get the
vessel ID using MMSI (vice versa). \$id indicates we want to focus on
the "id" info among all information returned by `get_vessel_info`

```{r}
vessel_id <- get_vessel_info(query = 224224000, search_type = "basic", key = key)$id
```

To get a list of port visits for that vessel with `get_event`, we
specify the type, the vessel id, confidences and our key. We will see a
list of events being returned, including the date, duration, location,
etc. Also each event has a event id (which is different with vessel id)

```{r}
get_event(event_type='port_visit',
          vessel = vessel_id,
          confidences = '4',
          key = key
)
```

We can also use more than one vessel id by listing all the ids. Also, we
can specify the start date and end date for the events to look at a
specific duration of events.

```{r}
get_event(event_type='port_visit',
          vessel = '8c7304226-6c71-edbe-0b63-c246734b3c01,6583c51e3-3626-5638-866a-f47c3bc7ef7c',
          confidences = 4,
          start_date = "2020-01-01",
          end_date = "2020-02-01",
          key = key
)
```

Let's try another event type

```{r}
get_event(event_type='encounter',
          start_date = "2020-01-01",
          end_date = "2020-02-01",
          key = key
)

```

Another example: let's combine the Vessels and Events APIs to get
fishing events for a list of 10 USA-flagged trawlers. We firstly search
about all these vessels which come from USA, and has geartype "trawlers"
using the function `get_vessel_info`. Then we save the ids for the first
100 vessels that satisfy the options.

```{r}
# Download the list of USA trawlers
usa_trawlers <- get_vessel_info(
  query = "flag = 'USA' AND geartype = 'trawlers'", 
  search_type = "advanced", 
  dataset = "fishing_vessel",
  key = key
)

# Collapse vessel ids into a commas separated list to pass to Events API (In human language it is to generate a ids list in the format it wants for later use)
usa_trawler_ids <- paste0(usa_trawlers$id[1:100], collapse = ',')
```

Now get the list of fishing events for these USA trawlers in January,
2020 (Using the previous ids list)

```{r}
get_event(event_type='fishing',
          vessel = usa_trawler_ids,
          start_date = "2020-01-01",
          end_date = "2020-02-01",
          key = key
)
```

When no events are available, the get_event() function returns nothing.

```{r}
get_event(event_type='fishing',
          vessel = usa_trawler_ids,
          start_date = "2020-01-01",
          end_date = "2020-01-01",
          key = key
)
```

## Map API

The `get_raster` function gets a raster and converts the response to a
data frame. In order to use it, you should specify:

-   The spatial resolution, which can be low (0.1 degree) or high (0.01
    degree)
-   The temporal resolution, which can be daily, monthly, or yearly.
-   The variable to group by: vessel_id, flag, gearType, or
    flagAndGearType
-   The date range note: this must be one (1) year or less
-   The geojson region or region code (such as an EEZ code) to filter
    the raster
-   The source for the specified region (currently, eez, mpa, or
    user_json)

```{r}
# This is a manually input polygon region

region_json = '{"geojson":{"type":"Polygon","coordinates":[[[-76.11328125,-26.273714024406416],[-76.201171875,-26.980828590472093],[-76.376953125,-27.527758206861883],[-76.81640625,-28.30438068296276],[-77.255859375,-28.767659105691244],[-77.87109375,-29.152161283318918],[-78.486328125,-29.45873118535532],[-79.189453125,-29.61167011519739],[-79.892578125,-29.6880527498568],[-80.595703125,-29.61167011519739],[-81.5625,-29.382175075145277],[-82.177734375,-29.07537517955835],[-82.705078125,-28.6905876542507],[-83.232421875,-28.071980301779845],[-83.49609375,-27.683528083787756],[-83.759765625,-26.980828590472093],[-83.84765625,-26.35249785815401],[-83.759765625,-25.64152637306576],[-83.583984375,-25.16517336866393],[-83.232421875,-24.447149589730827],[-82.705078125,-23.966175871265037],[-82.177734375,-23.483400654325635],[-81.5625,-23.241346102386117],[-80.859375,-22.998851594142906],[-80.15625,-22.917922936146027],[-79.453125,-22.998851594142906],[-78.662109375,-23.1605633090483],[-78.134765625,-23.40276490540795],[-77.431640625,-23.885837699861995],[-76.9921875,-24.28702686537642],[-76.552734375,-24.846565348219727],[-76.2890625,-25.48295117535531],[-76.11328125,-26.273714024406416]]]}}'

get_raster(
  spatial_resolution = 'low',
  temporal_resolution = 'yearly',
  group_by = 'flag',
  date_range = '2021-01-01,2021-12-31',
  region = region_json,
  region_source = 'user_json',
  key = key
  )
```

If you want raster data from a particular Exclusive economic zone (EEZ),
you can use the `get_region_id` function to get the EEZ id, enter that
code in the region argument of `get_raster` instead of the geojson data
(ensuring you specify the `region_source` as 'eez':

Example: Use `get_region_id` function to get EEZ code of Cote d'Ivoire.
And then get the raster of this eez

```{r}
code_eez <- get_region_id(region_name = 'kr', region_source = 'eez', key = key)

get_raster(spatial_resolution = 'low',
           temporal_resolution = 'yearly',
           group_by = 'flag',
           date_range = '2021-01-01,2021-10-01',
           region = code_eez$id,
           region_source = 'eez',
           key = key)
```

You can also search for just one word in the name of the EEZ and then
decide which one you want. And then use the `id` returned to retrieve
raster for that region. Example: Raster for "french" something

```{r}
(get_region_id(region_name = 'French', region_source = 'eez', key = key))

```

```{r}
get_raster(spatial_resolution = 'low',
           temporal_resolution = 'yearly',
           group_by = 'flag',
           date_range = '2021-01-01,2021-10-01',
           region = 8440,
           region_source = 'eez',
           key = key)
```

A similar approach can be used to search for a specific Marine Protected
Area, in this case the Phoenix Island Protected Area (PIPA). You can use
`get_region_id` as well for a moraine protected area as well.

```{r}
code_mpa <- get_region_id(region_name = 'Phoenix', region_source = 'mpa', key = key)

get_raster(spatial_resolution = 'low',
           temporal_resolution = 'yearly',
           group_by = 'flag',
           date_range = '2015-01-01,2015-06-01',
           region = code_mpa$id[1],
           region_source = 'mpa',
           key = key)
```

## Several examples to see how these information can be visualized

```{r}
library(maps)
library(ggmap)
library(tidyverse)
library(plotly)
```

### Example 1

Looking for a Japanese trawlers.
```{r}
jp_trawlers <- get_vessel_info(
  query = "flag = 'JPN' AND geartype = 'trawlers'", 
  search_type = "advanced", 
  dataset = "fishing_vessel",
  key = key
)
```


Get the fishing history for one vessel named `Yamada` by inputting its
vessel id found in `jp_trawlers`. We can plot where it travels using ggplot2 and plotly (a data visualization tool which is interactive and more powerful). We can
simply call `ggplotly` to turn a ggplot2 plot into interactive plotly
plot.


```{r}
#Save the history into yamada_track
yamada_fishing_track <- get_event(event_type='fishing',
          vessel = "380fc4e37-7f21-5402-84a3-ad2b7d08d709",
          start_date = "2016-01-01",
          end_date = "2022-12-31",
          key = key
)

#Draw a map with this area
area <- c(left = 123,
          right = 133,
          bottom = 29,
          top = 37)
v_map <- get_stamenmap(bbox = area, zoom = 7)

#Plot the coordinates on the map
v_final_map <- ggmap(v_map) + 
    geom_point(data = yamada_fishing_track, aes(x = lon, y = lat)) + # Add coordinate data
    theme_bw() + # Change the plot theme
    ggtitle("Track of yamada fishing location from 2016 to 2022") + # Give the plot a title
    xlab("Longitude") + # Change x axis title
    ylab("Latitude") # Change y axis title
ggplotly()
```


### Example 2

```{r}
#Save the history into yamada_track
yamada_port_track <- get_event(event_type='port_visit',
          vessel = "380fc4e37-7f21-5402-84a3-ad2b7d08d709",
          confidences = 4,
          start_date = "2016-01-01",
          end_date = "2022-12-31",
          key = key
)

#Draw a map with this area
area <- c(left = 123,
          right = 133,
          bottom = 29,
          top = 37)
v_map <- get_stamenmap(bbox = area, zoom = 7)

#Plot the coordinates on the map
v_final_map <- ggmap(v_map) + 
    geom_point(data = yamada_port_track, aes(x = lon, y = lat)) + # Add coordinate data
    theme_bw() + # Change the plot theme
    ggtitle("Track of yamada fishing location from 2016 to 2022") + # Give the plot a title
    xlab("Longitude") + # Change x axis title
    ylab("Latitude") # Change y axis title
ggplotly()
```




### Example 3

Get vessels information for those appearing in a EEZ region. Plot this
location and see where vessels appeared in this region.

```{r}
# Get the eez code for a EEZ in Korea
get_region_id(region_name = 'Korea', region_source = 'eez', key = key)
```


```{r}
# Get the raster for this EEZ
kr_raster <- get_raster(spatial_resolution = 'low',
           temporal_resolution = 'yearly',
           group_by = 'flagAndGearType',
           date_range = '2021-07-01,2021-07-15',
           region = 21796,
           region_source = 'eez',
           key = key)

# Draw a map with this area
area <- c(left = 124,
          right = 131,
          bottom = 28,
          top = 35)
r_map <- get_stamenmap(bbox = area, zoom = 7)

# Plot the appearance within this area on the map
raster_final_map <- ggmap(r_map) + 
    geom_point(data = kr_raster, aes(x = Lon, y = Lat)) + # Add coordinate data
    theme_bw() + # Change the plot theme
    ggtitle("Moving track of yamada in 2021") + # Give the plot a title
    xlab("Longitude") + # Change x axis title
    ylab("Latitude") # Change y axis title
ggplotly()
```

### Example 4

For this region "kr", we would like to see where these vessels come
from. With `kr_raster`, which is the raster for kr we previously
obtained, we can easily group the data by the `Flag` category. And then
plot the flag distribution with plotly.

```{r}
# Summarize the data to get the flag distribution using previous raster for kr
flag_summary <- kr_raster %>%
  group_by(Flag) %>%
  summarise(count = n()) %>%
  mutate(percentage = count / sum(count) * 100)

# Create the pie chart
plot_ly(flag_summary, 
             labels = ~Flag, 
             values = ~count, 
             type = 'pie', 
             textposition = 'inside',
             textinfo = 'label+percent',
             insidetextorientation = 'radial')
```

### Example 5

Similar with previous example, we can see the gear distribution for
vessels in kr.

```{r}
# Summarize the data to get the Gear distribution
gear_summary <- kr_raster %>%
  group_by(Geartype) %>%
  summarise(count = n())

plot_ly(gear_summary, 
             labels = ~Geartype, 
             values = ~count, 
             type = 'pie', 
             textposition = 'inside',
             textinfo = 'label+percent',
             insidetextorientation = 'radial')

```

TODO: For a EEZ, number of vessel/fishing event w.r.t. months.
We can see how seasons affect fishing in korea/japan region
```{r}

```

```{r}

```

```{r}

```
